// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    // NOTE: When using postgresql, mysql or sqlserver, uncomment the @db.Text annotations in model Account below
    // Further reading:
    // https://next-auth.js.org/adapters/prisma#create-the-prisma-schema
    // https://www.prisma.io/docs/reference/api-reference/prisma-schema-reference#string
    url = env("DATABASE_URL")
}

model Example {
    id        String   @id @default(cuid())
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
}
enum Plan {
    None
    Starter
    Pro
    Elite
}

// Necessary for Next auth
model Account {
    id                String  @id @default(cuid())
    userId            String
    type              String
    provider          String
    providerAccountId String
    refresh_token     String? @db.Text
    access_token      String? @db.Text
    expires_at        Int?
    token_type        String?
    scope             String?
    id_token          String? @db.Text
    session_state     String?
    user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@unique([provider, providerAccountId])
}

model Session {
    id           String   @id @default(cuid())
    sessionToken String   @unique
    userId       String
    expires      DateTime
    user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
    id            String    @id @default(cuid())
    name          String?
    email         String?   @unique
    emailVerified DateTime?
    image         String?
    credits       Decimal   @default(1.0) @db.Decimal(10, 2)
    plan          Plan      @default(None) // New field to track plan
    accounts      Account[]
    sessions      Session[]
    icons         Icon[]
    cpaUnlocks    CpaUnlock[]

    productOrders ProductOrder[]
    stripeWebhookEvents StripeWebhookEvent[]
}

model Icon {
    id            String    @id @default(cuid())
    prompt        String?
    User          User?     @relation(fields: [userId], references: [id])
    userId        String?
    createdAt DateTime @default(now()) 
    isPublic  Boolean  @default(true)
    metadata  Json?
    transparentImageUrl String?
    backgroundRemovedAt DateTime?
}

model VerificationToken {
    identifier String
    token      String   @unique
    expires    DateTime

    @@unique([identifier, token])
}

enum CpaStatus {
    pending
    approved
    rejected
}

enum CpaResult {
    complete
    screenout_bonus
    screenout_no_bonus
    reversed
}

enum CpaNetwork {
    cpx
}

model CpaUnlock {
    id            String     @id @default(cuid())
    userId        String
    user          User       @relation(fields: [userId], references: [id])

    token         String     @unique
    network       CpaNetwork
    status        CpaStatus  @default(pending)
    result        CpaResult?

    transactionId String?
    payout        Float?
    currency      String?
    leadIp        String?

    createdAt     DateTime   @default(now())
    approvedAt    DateTime?
    expiredAt     DateTime?
}

model PrintfulOrder {
    id               String   @id @default(cuid())
    productOrderId   String   @unique
    productOrder     ProductOrder @relation(fields: [productOrderId], references: [id])

    printfulOrderId  String
    status           String   // draft | submitted | fulfilled | canceled
    trackingNumber   String?
    trackingUrl      String?
    trackingCarrier  String?
    trackingStatus   String?
    shippedAt        DateTime?
    trackingUpdatedAt DateTime?

    createdAt        DateTime @default(now())
}

model ProductOrder {
    id           String   @id @default(cuid())
    userId       String
    user         User     @relation(fields: [userId], references: [id])

    productKey   String   // poster | tshirt | mug
    variantId    Int
    variantName  String?
    size         String?
    color        String?
    colorHex     String?
    aspect       String?
    previewMode  String?  // for mug: two-side | center
    previewVariantId Int?
    isBackgroundRemoved Boolean? @default(false)
    snapshotVariantId Int?
    snapshotSize     String?
    snapshotColor    String?
    snapshotPrintPosition String?
    snapshotBackgroundRemoved Boolean? @default(false)

    imageUrl     String
    mockupUrl    String

    basePrice    Float    // Printful base price
    margin       Float    // Your margin
    shippingPrice Float?
    shippingCurrency String?
    totalPrice   Float    // basePrice + margin (NO shipping yet)
    currency     String   @default("USD")

    name         String?
    address1     String?
    city         String?
    zip          String?
    country      String?
    state        String?

    status       String   @default("pending") 
    
    stripeSessionId String?   // set after Stripe checkout
    paidAt          DateTime?

    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt

    printfulOrder PrintfulOrder?
}

model StripeWebhookEvent {
    id              String   @id
    type            String
    stripeSessionId String?
    userId          String?
    user            User?    @relation(fields: [userId], references: [id])
    createdAt       DateTime @default(now())
}
